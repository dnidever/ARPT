pro ccdproc_overtrim,im,head,overscan=overscan,error=error,silent=silent

; Overscan correct and trim images

; Trim
strimsec = strtrim(sxpar(head,'TRIMSEC',/silent),2)
tsec = ccdproc_splitsec(strimseca)-1
im = origim[tseca[0]:tseca[1],tseca[2]:tseca[3]]
sz = size(im)

; Overscan correct
if keyword_set(overscan) then begin

  ; Bias/Overscan
  sbiassec = strtrim(sxpar(head,'BIASSEC',/silent),2)
  bsec = ccdproc_splitsec(sbiassec)-1
  bias = im[bsec[0]:bsec[1],bsec[2]:bsec[3]]

  ; collapse overscan image along short dimension
  szbias = size(bias)
  if szbias[1] gt szbias[2] then dim=2 else dim=1  ; which dimension to collapse
  med = median(bias,dim=dim)

  ; Bias/image do not have the same size
  if (dim eq 1 and sz[2] ne szbias[2]) or (dim eq 2 and sz[1] ne szbias[1]) then begin
    error = 'Overscan and Image do not have the same size'
    if not keyword_set(silent) then print,eror
    return
  endif

  ; Subtract overscan
  if dim eq 1 then begin
    im -= replicate(1,sz[1])#med
  endif else begin
    im -= med#replicate(1,sz[2])
  endelse

endif

; Update NAXIS1/NAXIS2
sz = size(im)
sxaddpar,head,'NAXIS',2
sxaddpar,head,'NAXIS1',sz[1]
sxaddpar,head,'NAXIS2',sz[2]
sxaddpar,head,'BITPIX',32
sxaddpar,head,'BZERO',0.0
sxaddpar,head,'BSCALE',1.0

; Put processing step in header
;OVSNMEAN=             1503.989                                                  
;TRIM    = 'Oct  8 21:19 Trim is [25:1048,1:4096]'                               
;OVERSCAN= 'Oct  8 21:19 Overscan is [1063:1112,1:4096], mean 1503.989'  
date = systime(0)
;Sun Oct  7 15:38:23 2012
datearr = strtrim(strsplit(date,' ',/extract),2)
timarr = strsplit(datearr[3],':',/extract)
datestr = datearr[1]+' '+datearr[2]+' '+strjoin(timarr[0:1],':')

sxaddpar,head,'TRIM',datestr+' Trim is '+strimsec+' '+strimsec
if keyword_set(overscan) then begin
  sxaddpar,head,'OVSNMEAN',strtrim(string(median(med),format='(F15.3)'),2)
  sxaddpar,head,'OVERSCAN',datestr+' Overscan is '+sbiassec
endif

end
