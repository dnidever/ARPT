pro dcm_bpm

; Make DECam bad pixel mask

; Use Zero and Dflats

zfile = 'Zero.fits'
;dfile = 'Dflat_g.fits'

outfile = 'bpm.fits'

fits_open,zfile,fcb
next = fcb.nextend
fits_close,fcb

head0 = headfits(zfile,exten=0)

fits_write,outfile,0,head0

for i=1,next do begin

  fits_read,zfile,zim,zhead,exten=i,/no_pdu
  ;fits_read,dfile,dim,dhead,exten=i

  zim0 = zim
  ; subtract median from each amp
  med1 = median(zim[0:1023,*])
  med2 = median(zim[1024:*,*])
  zimsub = [zim[0:1023,*]-med1,zim[1024:*,*]-med2]
  zsig = mad(zimsub)


  bpm = abs(zimsub) gt 10*zsig

  bhead = zhead
  sxaddpar,bhead,'BITPIX',8

  ; Save
  MWRFITS,bpm,outfile,bhead,/silent

endfor

;stop

end
